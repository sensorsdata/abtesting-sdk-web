!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():t()}(this,function(){"use strict";var e={sd:null,lib_version:"0.0.6",para:{},default_para:{url:"",path:"",project_key:"",timeout_milliseconds:3e3,update_interval:6e5,collect_bridge_status:!0,session_limit:6e5},value_type_list:["Number","String","Object","Boolean"],state:{platform:"",storage:{isSupport:!0,name:"sawebjssdkabtest"}},bridgeState:"",localdata:{},originalData:[],triggerList:{},updateTime:null},t={},r=Array.prototype,i=Object.prototype,a=r.slice,s=i.toString,n=i.hasOwnProperty,o=r.forEach,l=Array.isArray,c={};return t.each=function(e,r,i){if(null==e)return!1;if(o&&e.forEach===o)e.forEach(r,i);else if(t.isArray(e)&&e.length===+e.length){for(var a=0,s=e.length;a<s;a++)if(a in e&&r.call(i,e[a],a,e)===c)return!1}else for(var l in e)if(n.call(e,l)&&r.call(i,e[l],l,e)===c)return!1},t.extend=function(e){return t.each(a.call(arguments,1),function(t){for(var r in t)n.call(t,r)&&void 0!==t[r]&&(e[r]=t[r])}),e},t.isArray=l||function(e){return"[object Array]"===s.call(e)},t.isObject=function(e){return null!=e&&"[object Object]"==s.call(e)},t.isElement=function(e){return!(!e||1!==e.nodeType)},t.isString=function(e){return"[object String]"==s.call(e)},t.isBoolean=function(e){return"[object Boolean]"==s.call(e)},t.isNumber=function(e){return"[object Number]"==s.call(e)&&/[\d\.]+/.test(String(e))},t.unique=function(e){for(var t,r=[],i={},a=0;a<e.length;a++)t=e[a],t in i||(i[t]=!0,r.push(t));return r},t.decodeURIComponent=function(e){var t=e;try{t=decodeURIComponent(e)}catch(r){t=e}return t},t.getQueryParam=function(e,r){r=r.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e=t.decodeURIComponent(e);var i="[\\?&]"+r+"=([^&#]*)",a=new RegExp(i),s=a.exec(e);return null===s||s&&"string"!=typeof s[1]&&s[1].length?"":t.decodeURIComponent(s[1])},t.indexOf=function(e,t){var r=e.indexOf;if(r)return r.call(e,t);for(var i=0;i<e.length;i++)if(t===e[i])return i;return-1},t.isFunction=function(e){if(!e)return!1;var t=Object.prototype.toString.call(e);return"[object Function]"==t||"[object AsyncFunction]"==t},t.isEmptyObject=function(e){if(t.isObject(e)){for(var r in e)if(n.call(e,r))return!1;return!0}return!1},t.map=function(e,r){var i=[];return null==e?i:Array.prototype.map&&e.map===Array.prototype.map?e.map(r):(t.each(e,function(e,t,a){i.push(r(e,t,a))}),i)},t.base64Decode=function(e){var r=t.map(atob(e).split(""),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)});return decodeURIComponent(r.join(""))},t.getURLSearchParams=function(e){e=e||"";for(var t=function(e){return decodeURIComponent(e)},r={},i=e.substring(1),a=i.split("&"),s=0;s<a.length;s++){var n=a[s].indexOf("=");if(n!==-1){var o=a[s].substring(0,n),l=a[s].substring(n+1);o=t(o),l=t(l),r[o]=l}}return r},t.urlParse=function(e){var r=function(e){this._fields={Username:4,Password:5,Port:7,Protocol:2,Host:6,Path:8,URL:0,QueryString:9,Fragment:10},this._values={},this._regex=null,this._regex=/^((\w+):\/\/)?((\w+):?(\w+)?@)?([^\/\?:]+):?(\d+)?(\/?[^\?#]+)?\??([^#]+)?#?(\w*)/,"undefined"!=typeof e&&this._parse(e)};return r.prototype.setUrl=function(e){this._parse(e)},r.prototype._initValues=function(){for(var e in this._fields)this._values[e]=""},r.prototype.addQueryString=function(e){if("object"!=typeof e)return!1;var t=this._values.QueryString||"";for(var r in e)t=new RegExp(r+"[^&]+").test(t)?t.replace(new RegExp(r+"[^&]+"),r+"="+e[r]):"&"===t.slice(-1)?t+r+"="+e[r]:""===t?r+"="+e[r]:t+"&"+r+"="+e[r];this._values.QueryString=t},r.prototype.getUrl=function(){var e="";return e+=this._values.Origin,e+=this._values.Port?":"+this._values.Port:"",e+=this._values.Path,e+=this._values.QueryString?"?"+this._values.QueryString:"",e+=this._values.Fragment?"#"+this._values.Fragment:""},r.prototype.getUrl=function(){var e="";return e+=this._values.Origin,e+=this._values.Port?":"+this._values.Port:"",e+=this._values.Path,e+=this._values.QueryString?"?"+this._values.QueryString:""},r.prototype._parse=function(e){this._initValues();var r=this._regex.exec(e);r||t.log("DPURLParser::_parse -> Invalid URL");for(var i in this._fields)"undefined"!=typeof r[this._fields[i]]&&(this._values[i]=r[this._fields[i]]);this._values.Hostname=this._values.Host.replace(/:\d+$/,""),this._values.Origin=this._values.Protocol+"://"+this._values.Hostname},new r(e)},t.URL=function(e){var r={},i=function(){var e;try{return e=new URL("http://modernizr.com/"),"http://modernizr.com/"===e.href}catch(t){return!1}};if("function"==typeof window.URL&&i())r=new URL(e),r.searchParams||(r.searchParams=function(){var e=t.getURLSearchParams(r.search);return{get:function(t){return e[t]}}}());else{var a=/^https?:\/\/.+/;a.test(e)===!1&&t.log("Invalid URL");var s=t.urlParse(e);r.hash="",r.host=s._values.Host?s._values.Host+(s._values.Port?":"+s._values.Port:""):"",r.href=s._values.URL,r.password=s._values.Password,r.pathname=s._values.Path,r.port=s._values.Port,r.search=s._values.QueryString?"?"+s._values.QueryString:"",r.username=s._values.Username,r.hostname=s._values.Hostname,r.protocol=s._values.Protocol?s._values.Protocol+":":"",r.origin=s._values.Origin?s._values.Origin+(s._values.Port?":"+s._values.Port:""):"",r.searchParams=function(){var e=t.getURLSearchParams("?"+s._values.QueryString);return{get:function(t){return e[t]}}}()}return r},t.getQueryParam=function(e,r){r=r.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e=t.decodeURIComponent(e);var i="[\\?&]"+r+"=([^&#]*)",a=new RegExp(i),s=a.exec(e);return null===s||s&&"string"!=typeof s[1]&&s[1].length?"":t.decodeURIComponent(s[1])},t.isEmptyObject=function(e){if(t.isObject(e)){for(var r in e)if(n.call(e,r))return!1;return!0}return!1},t.contentLoaded=function(e,t){var r=!1,i=!0,a=e.document,s=a.documentElement,n=a.addEventListener,o=n?"addEventListener":"attachEvent",l=n?"removeEventListener":"detachEvent",c=n?"":"on",u=function(i){"readystatechange"==i.type&&"complete"!=a.readyState||(("load"==i.type?e:a)[l](c+i.type,u,!1),!r&&(r=!0)&&t.call(e,i.type||i))},h=function(){try{s.doScroll("left")}catch(e){return void setTimeout(h,50)}u("poll")};if("complete"==a.readyState)t.call(e,"lazy");else{if(!n&&s.doScroll){try{i=!e.frameElement}catch(p){}i&&h()}a[o](c+"DOMContentLoaded",u,!1),a[o](c+"readystatechange",u,!1),e[o](c+"load",u,!1)}},t.secCheck={isHttpUrl:function(e){if("string"!=typeof e)return!1;var r=/^https?:\/\/.+/;return r.test(e)!==!1||(t.log("Invalid URL"),!1)},removeScriptProtocol:function(e){if("string"!=typeof e)return"";for(var t=/^\s*javascript/i;t.test(e);)e=e.replace(t,"");return e}},t.addEvent=function(){function e(t){return t&&(t.preventDefault=e.preventDefault,t.stopPropagation=e.stopPropagation,t._getPath=e._getPath),t}function t(t,r,i){var a=function(a){if(a=a||e(window.event)){a.target=a.srcElement;var s,n,o=!0;return"function"==typeof i&&(s=i(a)),n=r.call(t,a),!1!==s&&!1!==n||(o=!1),o}};return a}e._getPath=function(){var e=this,t=function(){try{var t=e.target,r=[t];if(null===t||null===t.parentElement)return[];for(;null!==t.parentElement;)t=t.parentElement,r.unshift(t);return r}catch(i){return[]}};return this.path||this.composedPath&&this.composedPath()||t()},e.preventDefault=function(){this.returnValue=!1},e.stopPropagation=function(){this.cancelBubble=!0};var r=function(r,i,a){var s=!0;if(r&&r.addEventListener)r.addEventListener(i,function(t){t._getPath=e._getPath,a.call(this,t)},s);else{var n="on"+i,o=r[n];r[n]=t(r,a,o)}};r.apply(null,arguments)},t.addSinglePageEvent=function(e){var r=location.href,i=window.history.pushState,a=window.history.replaceState;window.history.pushState=function(){i.apply(window.history,arguments),e(r),r=location.href},window.history.replaceState=function(){a.apply(window.history,arguments),e(r),r=location.href};var s=i?"popstate":"hashchange";t.addEvent(window,s,function(){e(r),r=location.href})},e.verifyStore={valueType:function(e,r){switch(r){case"Number":if(t.isNumber(e))return!0;break;case"String":if(t.isString(e))return!0;break;case"Object":if(t.isObject(e))return!0;break;case"Boolean":if(e===!0||e===!1)return!0;break;default:return!1}return!1},para:function(r,i,a){var s={verify_success:!0,para:null};return t.each(a,function(a,n){if("essential"===a)switch(n){case"param_name":t.isString(i.param_name)&&i.param_name.length>0||(e.error(r+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cparam_name\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01param_name:",i.param_name),s.verify_success=!1);break;case"value_type":t.isString(i.value_type)&&t.indexOf(e.value_type_list,i.value_type)!==-1||(e.error(r+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",i.value_type),s.verify_success=!1);break;case"default_value":"undefined"==typeof i.default_value?(e.error(r+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),s.verify_success=!1):e.verifyStore.valueType(i.default_value,i.value_type)||(e.error(r+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",i.default_value,i.value_type),s.verify_success=!1);break;case"callback":t.isFunction(i.callback)||(e.error(r+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0ccallback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),s.verify_success=!1);break;default:s.verify_success=!1}else if("not_essential"===a)switch(n){case"timeout_milliseconds":i.timeout_milliseconds=i.timeout_milliseconds||e.para.timeout_milliseconds||e.default_para.timeout_milliseconds,(!t.isNumber(i.timeout_milliseconds)||t.isNumber(i.timeout_milliseconds)&&i.timeout_milliseconds<=0)&&(t.log("timeout_milliseconds \u53c2\u6570\u9519\u8bef",i.timeout_milliseconds),i.timeout_milliseconds=e.para.timeout_milliseconds),i.timeout_milliseconds<200&&(i.timeout_milliseconds=200);break;case"properties":i.properties=t.isObject(i.properties)?i.properties:{}}}),s.para=i,s}},e.getSA=function(e){return!!(t.isObject(e)&&t.isObject(e.readyState)&&e.readyState.state>=3)&&(this.sd=e,!0)},e.log=function(){if("object"==typeof console&&console.log){t.isString(arguments[0])&&(arguments[0]="sensorsabtest————"+arguments[0]);try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}}},e.error=function(){if("object"==typeof console&&console.error)try{return console.error.apply(console,arguments)}catch(e){console.error(arguments[0])}},e.listenPageState=function(e){var r={visibleHandle:t.isFunction(e.visible)?e.visible:function(){},hiddenHandler:t.isFunction(e.hidden)?e.hidden:function(){},visibilityChange:null,hidden:null,isSupport:function(){return"undefined"!=typeof document[this.hidden]},init:function(){"undefined"!=typeof document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(this.hidden="mozHidden",this.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(this.hidden="msHidden",this.visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"),this.listen()},listen:function(){if(this.isSupport()){var e=this;document.addEventListener(e.visibilityChange,function(){document[e.hidden]?e.hiddenHandler():e.visibleHandle()},1)}else document.addEventListener?(window.addEventListener("focus",this.visibleHandle,1),window.addEventListener("blur",this.hiddenHandler,1)):(document.attachEvent("onfocusin",this.visibleHandle),document.attachEvent("onfocusout",this.hiddenHandler))}};r.init()},e.storage={set:function(t,r){e.state.storage.isSupport&&window.localStorage.setItem(r,JSON.stringify(t))},get:function(r){var i=null;e.state.storage.isSupport&&(i=window.localStorage.getItem(r));try{i=JSON.parse(i)}catch(a){t.log(a)}return i}},e.getStorageData=function(){return this.storage.get(e.state.storage.name)},e.setStorageData=function(t){this.storage.set(t,e.state.storage.name)},e.Mask=function(e){this.element=e,this.remove_timer=null,this.is_added=!1,this.is_abort=!1},e.Mask.prototype={show:function(e){var r=this,i=(new Date).getTime();return!!t.isElement(this.element)&&void t.contentLoaded(window,function(){if(r.is_abort)return!1;var a=document.getElementsByTagName("body")[0];if(t.isElement(a)&&(a.appendChild(r.element),r.is_added=!0,t.isNumber(e))){var s=(new Date).getTime()-i;e-=s,r.remove_timer=setTimeout(function(){r.remove()},e)}})},remove:function(){if(t.isElement(this.element)){if(this.is_abort||(this.is_abort=!0),this.is_added){this.is_added=!1;var e=document.getElementsByTagName("body")[0];if(!t.isElement(e))return;e.removeChild(this.element)}this.remove_timer&&(clearTimeout(this.remove_timer),this.remove_timer=null),this.element=null}}},e.asyncFetchABTest=function(){e.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},e.fastFetchABTest=function(){e.error("fastFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},e.fetchCacheABTest=function(){e.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},e.searchLocalExp=function(t){return e.localdata[t]?e.localdata[t]:null},e.getExpResult=function(r,i){var a=r.default_value,s=i?i:e.searchLocalExp(r.param_name);return t.isObject(s)?t.isObject(s.js_config)&&(s.js_config.type===r.value_type?(a=s.js_config.value,this.triggerHandle(s,r)):t.log("\u8bd5\u9a8c\u7ed3\u679c\u7c7b\u578b\u4e0e\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e0d\u4e00\u81f4\uff0cparam_name\uff1a"+r.param_name+"\uff0c\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\u4e3a\uff1a"+s.js_config.type+"\uff0c\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e3a\uff1a"+r.value_type)):t.log("localdata\u672a\u67e5\u8be2\u5230\u8bd5\u9a8c\u6570\u636e\uff0c\u8bd5\u9a8c\u53c2\u6570\u540d\u79f0\uff1a"+r.param_name),a},e.resolveVariables=function(r){this.localdata={};var i=this;t.each(r,function(r){if(t.isObject(r)&&r.variables&&t.isArray(r.variables)){if(r.experiment_type&&"CODE"!==r.experiment_type)return!1;t.each(r.variables,function(a){t.isObject(a)&&!i.localdata[a.name]&&(i.localdata[a.name]={abtest_experiment_id:r.abtest_experiment_id,abtest_experiment_group_id:r.abtest_experiment_group_id,is_control_group:r.is_control_group,is_white_list:r.is_white_list,value:a.value,type:a.type,js_config:e.getRelativeValue(a.value,a.type)})})}})},e.getRelativeValue=function(e,r){var i={},a={INTEGER:function(e){var r=parseFloat(e);isNaN(r)?t.log("\u539f\u59cb\u6570\u636e INTEGER \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e):(i.value=r,i.type="Number")},STRING:function(e){t.isString(e)?(i.value=e,i.type="String"):t.log("\u539f\u59cb\u6570\u636e STRING \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)},JSON:function(e){var r=JSON.parse(e);t.isObject(r)?(i.value=r,i.type="Object"):t.log("\u539f\u59cb\u6570\u636e JSON \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)},BOOLEAN:function(e){"true"===e?(i.value=!0,i.type="Boolean"):"false"===e?(i.value=!1,i.type="Boolean"):t.log("\u539f\u59cb\u6570\u636e BOOLEAN \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)}};try{a[r]?a[r](e):t.log("\u8bd5\u9a8c\u6570\u636e\u7c7b\u578b\u89e3\u6790\u5931\u8d25",r,e)}catch(s){t.log(s,e,r)}return i},e.link={isFirst:!0,start_time:null,mask_instance:null,is_filtered_out:!1,para:{timeout:500,use_mask:!1,pass_params:!0,control_link_search:"default",experiment_link_search:"default"},init:function(e){return this.initPara(e),this.para?t.getQueryParam(location.href,"saSDKMultilink")?(this.is_filtered_out=!0,!1):(this.start_time=(new Date).getTime(),this.para.use_mask&&this.initMask(),void this.addSinglePageListener()):(t.log("multilink is closed"),!1)},addSinglePageListener:function(){var r=this;t.addSinglePageEvent(function(i){return i!==location.href&&(r.is_filtered_out=!1,r.isFirst=!0,r.mask_instance&&r.mask_instance.remove(),t.getQueryParam(location.href,"saSDKMultilink")?(r.is_filtered_out=!0,!1):(r.start_time=(new Date).getTime(),r.para.use_mask&&r.initMask(),void r.resolve(e.originalData)))})},initMask:function(){var t=document.createElement("div");t.style.position="fixed",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.left="0px",t.style.background="#fff",this.mask_instance=new e.Mask(t),this.mask_instance.show(this.para.timeout)},initPara:function(e){if(t.isFunction(e))try{e=e()}catch(r){return t.log("link para error!"),void(this.para=!1)}e===!1?this.para=!1:t.isObject(e)&&(this.para.timeout=t.isNumber(e.timeout)&&e.timeout<=5e3&&e.timeout>=0?e.timeout:500,this.para.use_mask=!!t.isBoolean(e.use_mask)&&e.use_mask,this.para.control_link_search=t.isString(e.control_link_search)?e.control_link_search:"default",this.para.experiment_link_search=t.isString(e.experiment_link_search)?e.experiment_link_search:"default",this.para.pass_params=!t.isBoolean(e.pass_params)||e.pass_params)},resolve:function(r){var i=this;if(!this.para)return!1;if(!t.isArray(r))return!1;if(this.is_filtered_out)return!1;if(!this.isFirst)return!1;if(this.isFirst=!1,0===this.para.timeout)return!1;if((new Date).getTime()-this.start_time>this.para.timeout)return t.log("The multilink was stopped because the request timeout"),!1;var a=!1;t.each(r,function(r){if(!t.isObject(r))return!1;if(a)return!1;if("LINK"!==r.experiment_type)return!1;if(i.isTriggerLinkExp(r)){a=!0;var s=e.triggerHandle(r);s?setTimeout(function(){i.redirectUrl(r)},80):setTimeout(function(){i.redirectUrl(r)},0)}}),!a&&this.para.use_mask&&this.mask_instance.remove()},stopTrigger:function(){this.isFirst=!1,t.log("The multilink was stopped because the request failed"),this.para.use_mask&&this.mask_instance.remove()},isTriggerLinkExp:function(e){return t.isString(e.control_link)&&t.isString(e.link_match_type)?!!this.checkUrlIsMatch(e.control_link,e.link_match_type)||(t.log("\u591a\u94fe\u63a5\u8bd5\u9a8c\u5339\u914d\u5931\u8d25",e.abtest_experiment_id),!1):(t.log("\u591a\u94fe\u63a5\u8bd5\u9a8c\u6570\u636e\u5f02\u5e38",e.abtest_experiment_id),!1)},checkUrlIsMatch:function(e,r){var i,a;if("STRICT"===r)return location.href===e;if("FUZZY"===r){try{i=t.URL(location.href)}catch(s){return t.log("url \u89e3\u6790\u5931\u8d25",s),!1}try{a=t.URL(e)}catch(s){return t.log("control_url \u89e3\u6790\u5931\u8d25",s),!1}return i.host===a.host&&i.pathname===a.pathname}return t.log("link_match_type\u5b57\u6bb5\u5f02\u5e38",r),!1},redirectUrl:function(e){function r(e){return t.secCheck.isHttpUrl(e)?t.secCheck.removeScriptProtocol(e):(t.log("\u975e\u6cd5URL"),!1)}if(!e.experiment_link||!t.isString(e.experiment_link))return void t.log("\u9875\u9762\u8df3\u8f6c\u5931\u8d25\uff0cexperiment_link\u5b57\u6bb5\u5f02\u5e38",e.abtest_experiment_id);if(e.is_control_group!==!0||"STRICT"!==e.link_match_type){var i;if(this.para.pass_params){var a=this.getMergedUrl(e.is_control_group,e.experiment_link,location.href);i=r(a)}else{var a=this.getMergedUrl(e.is_control_group,e.experiment_link);i=r(a)}i&&(location.href=i)}},getMergedUrl:function(e,r,i){function a(e){var t=/([^?#]+)(\?[^#]*)?(#.*)?/,r=t.exec(e);if(r){var i=r[1]||"",a=r[2]||"",s=r[3]||"";return{host:i,search:a,hash:s}}}function s(e){var r={hash:"",search:""};if(!t.isString(e))return r;var i=e.indexOf("?");return i>-1?(r.search=e.slice(i),r.hash=e.slice(0,i)):r.hash=e,r}var n="",o="",l="",c={parse_url:null,search:""},u={parse_url:null,search:"",hash:""};return i&&(c.parse_url=a(i),!c.parse_url)?void t.log("url \u89e3\u6790\u5931\u8d25",i):(u.parse_url=a(r),u.parse_url?(i&&("after_hash"===this.para.control_link_search?c.search=s(c.parse_url.hash).search:c.search=c.parse_url.search),e?"after_hash"===this.para.control_link_search?(u.search=s(u.parse_url.hash).search,u.hash=s(u.parse_url.hash).hash):u.search=u.parse_url.search:"after_hash"===this.para.experiment_link_search?(u.search=s(u.parse_url.hash).search,u.hash=s(u.parse_url.hash).hash):u.search=u.parse_url.search,o=i?this.getSearchStr(c.search,u.search):this.getSearchStr(u.search),e&&"after_hash"===this.para.control_link_search||!e&&"after_hash"===this.para.experiment_link_search?n=u.hash.length>0?u.parse_url.host+u.parse_url.search+u.hash+o:u.parse_url.search.length>0?u.parse_url.host+u.parse_url.search+"&"+o.substring(1):u.parse_url.host+o:(l="after_hash"===this.para.control_link_search?u.parse_url.hash:i?u.parse_url.hash||c.parse_url.hash:u.parse_url.hash,n=u.parse_url.host+o+l),n):void t.log("url \u89e3\u6790\u5931\u8d25",r))},getSearchStr:function(e,r){function i(e){var t={};if(!e||!e.length||0!==e.indexOf("?"))return t;if(e=e.slice(1),!e.length)return t;for(var r=e.split("&"),i=0;i<r.length;i++)if(r[i].indexOf("=")<0)t[r[i]]=null;else{var a=r[i].split("=");t[a[0]]=a[1]}return t}var a=i(e),s=i(r),n=t.extend(a,s),o="";if(t.isEmptyObject(n))return"?saSDKMultilink=true";var l=!0;for(var c in n)l?(o+="?",l=!1):o+="&",null!==n[c]?o=o+c+"="+n[c]:o+=c;return o+="&saSDKMultilink=true"}},e.bridgeStore={interval_time:600,server_start_time:0,init:function(r){return!!this.setPara(r)&&(t.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f"),e.state.storage.name="sawebjssdkabtest_bridge",e.abBridge=new e.sd.JSBridge({type:"abtest",app_call_js:function(e){try{e=t.base64Decode(e)}catch(r){t.log("App\u6570\u636ebase64\u89e3\u7801\u5f02\u5e38",e)}try{e=JSON.parse(e),e.message_id&&this["double"](e)}catch(r){t.log("App\u6570\u636e\u89e3\u6790\u5f02\u5e38",e)}}}),t.isObject(window.SensorsData_iOS_JS_Bridge)&&window.SensorsData_iOS_JS_Bridge.sensorsdata_abtest_module&&e.abBridge.hasAppBridge()?e.bridgeState="ab_bridge_ok":t.isObject(window.SensorsData_APP_New_H5_Bridge)&&t.isFunction(window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module)&&window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module()&&e.abBridge.hasAppBridge()?e.bridgeState="ab_bridge_ok":e.bridgeState="ab_no_abtest_bridge",void e.store.init(this.getResultFromApp,this))},setPara:function(r){var i=e.verifyStore.para("\u6253\u901a\u521d\u59cb\u5316",r,{timeout_milliseconds:"not_essential"});return e.para=t.extend({},e.default_para,i.para),t.isBoolean(e.para.collect_bridge_status)||(e.para.collect_bridge_status=!0),t.isNumber(e.para.update_interval)||(e.para.update_interval=6e5),!0},getResultFromApp:function(r){function i(){"ab_bridge_ok"===e.bridgeState?e.abBridge.requestToApp({data:{properties:a.properties,timeout:o,request_body:{origin_platform:"H5"}},callback:function(r){t.isObject(r)&&t.isObject(r.data)?(t.log("\u6210\u529f\u83b7\u53d6\u5230 App \u7aef\u8fd4\u56de\u7684\u8bd5\u9a8c\u6570\u636e","data:",r),e.dealResponseData(r.data),s&&s(r)):(t.log("App \u7aef\u8bf7\u6c42\u5931\u8d25"),n&&n()),e.fetchData.setNextFetch()},timeout:{time:o,callback:function(){t.log("\u83b7\u53d6App\u7aef\u6570\u636e\u5931\u8d25"),n&&n(),e.fetchData.setNextFetch()}}}):n&&(t.log("A/B Testing \u6253\u901a\u5931\u8d25\uff0c",e.bridgeState),n())}r=t.isObject(r)?r:{};var a=r.para||{},s=r.suc,n=r.err,o=a.timeout_milliseconds||e.para.timeout_milliseconds;this.server_start_time=1*new Date,t.log("\u5411App\u53d1\u8d77\u8bd5\u9a8c\u8bf7\u6c42"),i()},asyncFetch:function(r){e.bridgeStore.getResultFromApp({para:r,suc:function(i){if(t.isObject(i.properties)&&(r.properties=t.extend(i.properties,r.properties)),"SUCCESS"===i.data.status){var a=e.getExpResult(r);r.callback(a)}else r.callback(r.default_value)},err:function(){r.callback(r.default_value)}})}},e.bridgeStore.methods={asyncFetchABTest:function(r){if(!t.isObject(r))return e.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var i=e.verifyStore.para("asyncFetchABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential",callback:"essential",timeout_milliseconds:"not_essential",properties:"not_essential"});i.verify_success&&(r=i.para,"ab_bridge_ok"===e.bridgeState?e.bridgeStore.asyncFetch(r):r.callback(r.default_value))},fastFetchABTest:function(r){if(!t.isObject(r))return e.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var i=e.verifyStore.para("fastFetchABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential",callback:"essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(i.verify_success){r=i.para;var a=e.searchLocalExp(r.param_name);if(t.isObject(a)){var s=e.getExpResult(r,a);r.callback(s)}else if(t.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),"ab_bridge_ok"===e.bridgeState){if(1*new Date-e.bridgeStore.server_start_time<=e.bridgeStore.interval_time)return void r.callback(r.default_value);e.bridgeStore.asyncFetch(r)}else r.callback(r.default_value)}},fetchCacheABTest:function(r){if(!t.isObject(r))return void e.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e");var i=e.verifyStore.para("fetchCacheABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential"});if(i.verify_success)return e.getExpResult(i.para)}},e.normalStore={interval_time:600,server_start_time:0,init:function(r){return!!this.setPara(r)&&(e.bridgeState="ab_no_host_bridge",/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)?e.state.platform="H5":e.state.platform="Web",t.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f\uff0c\u8bd5\u9a8c URL\uff1a",r.url),e.checkSADebug(),void e.store.init(this.getResultFromServer,this))},setPara:function(r){if(!t.isString(r.url)||"http"!==r.url.slice(0,4))return t.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1;if("https"===location.protocol.slice(0,5)&&"http:"===r.url.slice(0,5))return t.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0chttps \u9875\u9762\u5fc5\u987b\u4f7f\u7528 https \u7684 URL"),!1;var i=t.getQueryParam(r.url,"project-key");if(!i)return t.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff08\u5fc5\u987b\u5305\u542b project-key\uff09\uff01"),!1;r.project_key=i;var a=e.verifyStore.para("A/B Testing SDK \u521d\u59cb\u5316",r,{timeout_milliseconds:"not_essential"});return e.para=t.extend({},e.default_para,a.para),t.isBoolean(e.para.collect_bridge_status)||(e.para.collect_bridge_status=!0),t.isNumber(e.para.update_interval)||(e.para.update_interval=6e5),!0},asyncFetch:function(r){e.normalStore.getResultFromServer({para:r,suc:function(i){if(t.isObject(i)&&"SUCCESS"===i.status){var a=e.getExpResult(r);r.callback(a)}else r.callback(r.default_value)},err:function(){r.callback(r.default_value)}})},creatRequestData:function(r){var i="";t.isEmptyObject(e.sd.store._state)||(i=e.sd.store._state._first_id||e.sd.store._state.first_id||e.sd.store._state._distinct_id||e.sd.store._state.distinct_id);var a={anonymous_id:i,platform:e.state.platform,abtest_lib_version:e.lib_version,properties:{$is_first_day:e.sd._.cookie.getNewUser()}};return t.isObject(r.properties)&&(a.properties=t.extend({},a.properties,r.properties)),e.sd.store._state.first_id&&(a.login_id=e.sd.store.getDistinctId()),a},getResultFromServer:function(r){function i(){var r=e.sd.store.getDistinctId();e.sd._.ajax({url:e.para.url,type:"POST",data:JSON.stringify(o),credentials:!1,contentType:"application/json",timeout:a.timeout_milliseconds||e.para.timeout_milliseconds,cors:!0,success:function(t){e.dealResponseData(t,r),s&&s(t),e.fetchData.setNextFetch()},error:function(r){t.log("\u670d\u52a1\u7aef\u8bf7\u6c42\u53d1\u9001\u5931\u8d25",r),n&&n(),e.fetchData.setNextFetch()}})}r=t.isObject(r)?r:{};var a=r.para||{},s=r.suc,n=r.err,o=this.creatRequestData(a);this.server_start_time=1*new Date,t.log("\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bd5\u9a8c\u8bf7\u6c42"),i()}},e.normalStore.methods={asyncFetchABTest:function(r){if(!t.isObject(r))return e.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var i=e.verifyStore.para("asyncFetchABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential",callback:"essential",timeout_milliseconds:"not_essential",properties:"not_essential"});i.verify_success&&(r=i.para,e.normalStore.asyncFetch(r))},fastFetchABTest:function(r){if(!t.isObject(r))return e.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var i=e.verifyStore.para("fastFetchABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential",callback:"essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(i.verify_success){r=i.para;var a=e.searchLocalExp(r.param_name);if(t.isObject(a)){var s=e.getExpResult(r,a);r.callback(s)}else{if(1*new Date-e.normalStore.server_start_time<=e.normalStore.interval_time)return void r.callback(r.default_value);t.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),e.normalStore.asyncFetch(r)}}},fetchCacheABTest:function(r){if(!t.isObject(r))return void e.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e");var i=e.verifyStore.para("fetchCacheABTest",r,{param_name:"essential",value_type:"essential",default_value:"essential"});if(i.verify_success)return e.getExpResult(i.para)}},e.dealResponseData=function(r,i){t.isObject(r)?(t.isObject(r.configs)&&t.isNumber(r.configs.interval_time)&&(e.normalStore.interval_time=r.configs.interval_time,e.bridgeStore.interval_time=r.configs.interval_time),"SUCCESS"===r.status?t.isArray(r.results)&&(this.originalData=r.results,this.updateLocalData(r.results,i)):"FAILED"===r.status&&t.log("\u83b7\u53d6\u8bd5\u9a8c\u5931\u8d25\uff1aerror_type\uff1a"+r.error_type+",error\uff1a"+r.error)):t.log("\u8bd5\u9a8c\u6570\u636e\u89e3\u6790\u5931\u8d25\uff0cresponse \uff1a",r)},e.updateLocalData=function(e,r){this.analyzeData(e),this.updateStorage(r),t.log("\u66f4\u65b0\u8bd5\u9a8c\u6570\u636e\u6210\u529f")},e.updateStorage=function(t){var r=(new Date).getTime(),i={data:this.originalData,updateTime:r,triggerList:this.triggerList,distinct_id:t||e.sd.store.getDistinctId()};this.setStorageData(i),this.updateTime=r},e.analyzeData=function(r){return t.isArray(r)?(e.link.resolve(r),void e.resolveVariables(r)):(t.log("\u89e3\u6790——\u6570\u636e\u683c\u5f0f\u9519\u8bef",r),!1)},e.triggerHandle=function(r,i){var a=t.isObject(i)&&t.isObject(i.properties)?i.properties:{},s=e.trackTestTrigger(r,a),n=r.abtest_experiment_id;if(t.isString(n)){var o=e.sd.store.getDistinctId();this.triggerList[o]&&t.isArray(this.triggerList[o])?(this.triggerList[o].push(n),this.triggerList[o]=t.unique(this.triggerList[o])):this.triggerList[o]=[n],this.updateStorage()}return s},e.trackTestTrigger=function(r,i){var a=e.sd.store.getDistinctId(),s=!0,n=!0;if(i=t.isObject(i)?i:{},!r.is_white_list){if(this.triggerList&&t.isObject(this.triggerList)&&("{}"!==JSON.stringify(this.triggerList)&&(n=!1),this.triggerList[a]&&t.isArray(this.triggerList[a])&&t.each(this.triggerList[a],function(e){e===r.abtest_experiment_id&&(s=!1)})),s){var o={$abtest_experiment_id:r.abtest_experiment_id,$abtest_experiment_group_id:r.abtest_experiment_group_id};if(e.para.collect_bridge_status&&(o.$sdk_bridge_status=e.bridgeState),n){var l="web_abtesting:"+this.lib_version;o.$lib_plugin_version=[l]}var c=t.extend(o,i);this.sd.track("$ABTestTrigger",c)}return s}},e.checkSADebug=function(){var r=t.getQueryParam(location.href,"sensors_abtest_url"),i=t.getQueryParam(location.href,"feature_code"),a=+t.getQueryParam(location.href,"account_id");if(r.length&&i.length&&t.isNumber(a)&&0!==a){var s={distinct_id:e.sd.store.getDistinctId(),feature_code:i,account_id:a};e.sd._.ajax({url:r,type:"POST",data:JSON.stringify(s),credentials:!1,contentType:"application/json",timeout:e.para.timeout_milliseconds,cors:!0,success:function(){},error:function(e){t.log("distinct_id\u53d1\u9001\u5931\u8d25,err:",e)}})}},e.initMethods=function(r){var i=["asyncFetchABTest","fastFetchABTest","fetchCacheABTest"];t.each(i,function(t){e[t]=r.methods[t]})},e.fetchData={timer:null,method:null,context:null,init:function(e,t){this.method=e,this.context=t,this.start(!0)},getServerData:function(r){r?this.method.call(this.context,{suc:function(i){r&&("ab_bridge_ok"===e.bridgeState&&(i=i.data),t.isObject(i)&&"SUCCESS"===i.status&&t.isArray(i.results)||e.link.stopTrigger())},err:function(){r&&e.link.stopTrigger()}}):this.method.call(this.context)},setNextFetch:function(t){var r=this,i=t||e.para.update_interval;this.clearFetchTimer(this.timer),this.timer=setTimeout(function(){r.getServerData()},i)},start:function(r){var i=null,a=(new Date).getTime(),s=e.getStorageData(),n=e.sd.store.getDistinctId();if(s&&t.isObject(s)&&s.distinct_id===n)if(i=s.updateTime,r&&(e.originalData=s.data,i&&t.isNumber(i)&&a-i>0&&a-i<e.para.session_limit&&t.isObject(s.triggerList)&&(e.triggerList=s.triggerList),e.analyzeData(s.data)),i&&t.isNumber(i)&&a-i>0&&a-i<e.para.update_interval){t.log("\u6570\u636e\u4e0d\u66f4\u65b0",i,a);var o=a-i,l=e.para.update_interval-o;this.setNextFetch(l)}else t.log("\u7f13\u5b58\u6570\u636e\u8d85\u65f6",i,a),this.getServerData(r);else i=e.updateTime,i&&t.isNumber(i)&&a-i>0&&a-i<e.para.update_interval?t.log("\u6570\u636e\u4e0d\u66f4\u65b0",i,a):this.getServerData(r)},stop:function(){t.log("\u6e05\u7a7a\u62c9\u53d6\u5b9a\u65f6\u5668"),this.clearFetchTimer()},clearFetchTimer:function(){clearTimeout(this.timer),this.timer=null}},e.store={init:function(r,i){e.fetchData.init(r,i),e.initMethods(i),e.listenPageState({visible:function(){t.log("\u9875\u9762\u663e\u793a"),e.fetchData.start()},hidden:function(){e.fetchData.stop()}}),e.sd.events.on("changeDistinctId",function(t){e.localdata={},e.originalData=[],e.updateStorage(),e.fetchData.getServerData()}),e.sd.events.isReady()}},e.init=function(e,r){return this.sd?(this.log("A/B Testing SDK \u91cd\u590d\u521d\u59cb\u5316\uff01\u53ea\u6709\u7b2c\u4e00\u6b21\u521d\u59cb\u5316\u6709\u6548\uff01"),!1):(t.log=function(){return t.isString(arguments[0])&&(arguments[0]="sensorsabtest————"+arguments[0]),e.log.apply(this,arguments)},this.getSA(e)?t.isObject(r)?("object"==typeof localStorage&&this.sd._.localStorage.isSupport()||(t.log("localstorage\u5f02\u5e38"),this.state.storage.isSupport=!1),this.link.init(r.multilink),void(e.bridge.is_verify_success?this.bridgeStore.init(r):this.normalStore.init(r))):(t.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f20\u5165\u6b63\u786e\u7684\u521d\u59cb\u5316\u53c2\u6570!para:",r),!1):(this.log("A/B Testing \u521d\u59cb\u5316\u5931\u8d25,Web JS SDK \u6ca1\u6709\u521d\u59cb\u5316\u5b8c\u6210"),!1))},window.SensorsDataWebJSSDKPlugin&&"[object Object]"==Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.SensorsABTest=window.SensorsDataWebJSSDKPlugin.SensorsABTest||e:window.SensorsDataWebJSSDKPlugin={SensorsABTest:e},e});